# API仕様書

## 📌 概要

Smart Docs Chat システムの各フェーズで提供されるAPIの仕様を定義します。

---

## 🔌 共通仕様

### ベースURL
```
http://localhost:8000/api/v1
```

### 認証
```http
Authorization: Bearer {API_KEY}
```

### レスポンス形式
```json
{
  "status": "success|error",
  "data": {},
  "message": "string",
  "timestamp": "2025-01-21T10:00:00Z"
}
```

### エラーコード
| コード | 説明 |
|--------|------|
| 400 | Bad Request - パラメータエラー |
| 401 | Unauthorized - 認証エラー |
| 404 | Not Found - リソースが見つからない |
| 429 | Too Many Requests - レート制限 |
| 500 | Internal Server Error - サーバーエラー |

---

## 📋 Phase 2: Advanced RAG API

### POST /search
高度な検索を実行

#### リクエスト
```json
{
  "query": "string",
  "options": {
    "use_hyde": true,
    "use_fusion": true,
    "use_rerank": true,
    "k": 10
  },
  "filters": {
    "source": ["notion", "google_drive"],
    "date_from": "2024-01-01",
    "date_to": "2025-01-21"
  }
}
```

#### レスポンス
```json
{
  "status": "success",
  "data": {
    "query": "string",
    "answer": "string",
    "sources": [
      {
        "content": "string",
        "metadata": {
          "source": "notion",
          "page_id": "string",
          "score": 0.95
        }
      }
    ],
    "techniques_used": {
      "hyde": true,
      "fusion": true,
      "rerank": true
    },
    "processing_time": 3.2
  }
}
```

### POST /hyde
HyDE検索を実行

#### リクエスト
```json
{
  "query": "string",
  "k": 5
}
```

### POST /rag-fusion
RAG-Fusion検索を実行

#### リクエスト
```json
{
  "query": "string",
  "num_queries": 5,
  "k": 10
}
```

### POST /rerank
検索結果を再順位付け

#### リクエスト
```json
{
  "query": "string",
  "documents": [
    {
      "id": "string",
      "content": "string"
    }
  ],
  "top_k": 5,
  "method": "cohere|cross-encoder"
}
```

---

## 🤖 Phase 3: LangGraph Agent API

### POST /agent/react
ReActエージェントを実行

#### リクエスト
```json
{
  "task": "string",
  "tools": ["search", "calculator", "web_search"],
  "max_iterations": 5,
  "thread_id": "string"
}
```

#### レスポンス
```json
{
  "status": "success",
  "data": {
    "result": "string",
    "thoughts": [
      "Thought: 情報を検索する必要がある",
      "Action: search_knowledge_base",
      "Observation: 検索結果..."
    ],
    "actions": [
      {
        "tool": "search_knowledge_base",
        "input": "string",
        "output": "string"
      }
    ],
    "iterations": 3
  }
}
```

### GET /agent/state/{thread_id}
エージェントの状態を取得

#### レスポンス
```json
{
  "status": "success",
  "data": {
    "thread_id": "string",
    "current_step": "thinking",
    "messages": [],
    "search_results": [],
    "reflection_count": 1,
    "metadata": {}
  }
}
```

### POST /agent/checkpoint
チェックポイントを作成

#### リクエスト
```json
{
  "thread_id": "string",
  "checkpoint_name": "string"
}
```

### POST /agent/restore
チェックポイントから復元

#### リクエスト
```json
{
  "checkpoint_id": "string"
}
```

---

## 👥 Phase 4: Multi-Agent API

### POST /multi-agent/execute
マルチエージェントタスクを実行

#### リクエスト
```json
{
  "task": "string",
  "agents": ["researcher", "coder", "reviewer", "documenter"],
  "execution_mode": "parallel|sequential",
  "supervisor_config": {
    "max_iterations": 3,
    "timeout": 300
  }
}
```

#### レスポンス
```json
{
  "status": "success",
  "data": {
    "task": "string",
    "agents_used": ["researcher", "coder", "reviewer"],
    "execution_time": 45.2,
    "individual_results": {
      "researcher": {
        "status": "completed",
        "result": "string",
        "time": 10.5
      },
      "coder": {
        "status": "completed",
        "result": "string",
        "time": 20.3
      }
    },
    "final_answer": "string",
    "shared_memory": {}
  }
}
```

### POST /reflection/execute
セルフリフレクションを実行

#### リクエスト
```json
{
  "task": "string",
  "initial_response": "string",
  "max_iterations": 3,
  "criteria": {
    "completeness": true,
    "accuracy": true,
    "clarity": true
  }
}
```

### POST /requirements/generate
要件定義を生成

#### リクエスト
```json
{
  "project_description": "string",
  "num_personas": 3,
  "auto_interview": true
}
```

#### レスポンス
```json
{
  "status": "success",
  "data": {
    "personas": [
      {
        "name": "string",
        "role": "string",
        "goals": [],
        "pain_points": [],
        "expectations": []
      }
    ],
    "interviews": [],
    "requirements": [
      {
        "category": "functional",
        "description": "string",
        "priority": "high",
        "acceptance_criteria": []
      }
    ]
  }
}
```

### POST /plan-execute/create
実行計画を作成

#### リクエスト
```json
{
  "objective": "string",
  "context": "string",
  "auto_execute": false
}
```

---

## 📊 Monitoring API

### GET /metrics
システムメトリクスを取得

#### レスポンス
```json
{
  "status": "success",
  "data": {
    "total_requests": 1000,
    "average_response_time": 2.5,
    "success_rate": 0.98,
    "active_threads": 5,
    "cache_hit_rate": 0.75,
    "vector_db_size": 50000,
    "daily_usage": {
      "searches": 500,
      "agent_tasks": 100,
      "tokens_used": 1000000
    }
  }
}
```

### GET /health
ヘルスチェック

#### レスポンス
```json
{
  "status": "healthy",
  "services": {
    "api": "healthy",
    "vectordb": "healthy",
    "llm": "healthy",
    "cache": "healthy"
  },
  "version": "1.0.0",
  "uptime": 86400
}
```

---

## 🔐 Webhook API

### POST /webhooks/register
Webhookを登録

#### リクエスト
```json
{
  "url": "https://example.com/webhook",
  "events": ["search.completed", "agent.finished"],
  "secret": "string"
}
```

### Webhookペイロード
```json
{
  "event": "search.completed",
  "timestamp": "2025-01-21T10:00:00Z",
  "data": {
    "query": "string",
    "result": "string",
    "processing_time": 3.2
  },
  "signature": "sha256=..."
}
```

---

## 📝 SDKサンプル

### Python SDK
```python
from smart_docs_chat import Client

# クライアント初期化
client = Client(
    api_key="your-api-key",
    base_url="http://localhost:8000/api/v1"
)

# Advanced RAG検索
result = client.search(
    query="LangGraphの使い方",
    use_hyde=True,
    use_fusion=True,
    use_rerank=True
)

# エージェント実行
agent_result = client.agent.react(
    task="Pythonでフィボナッチ数列を実装して",
    tools=["coder", "reviewer"]
)

# マルチエージェント
multi_result = client.multi_agent.execute(
    task="RAGシステムの設計と実装",
    agents=["researcher", "coder", "documenter"],
    execution_mode="parallel"
)
```

### JavaScript/TypeScript SDK
```typescript
import { SmartDocsChat } from 'smart-docs-chat-sdk';

// クライアント初期化
const client = new SmartDocsChat({
  apiKey: 'your-api-key',
  baseUrl: 'http://localhost:8000/api/v1'
});

// Advanced RAG検索
const result = await client.search({
  query: 'LangGraphの使い方',
  options: {
    useHyde: true,
    useFusion: true,
    useRerank: true
  }
});

// エージェント実行
const agentResult = await client.agent.react({
  task: 'Pythonでフィボナッチ数列を実装して',
  tools: ['coder', 'reviewer']
});
```

### cURL例
```bash
# Advanced RAG検索
curl -X POST http://localhost:8000/api/v1/search \
  -H "Authorization: Bearer your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "LangGraphの使い方",
    "options": {
      "use_hyde": true,
      "use_fusion": true,
      "use_rerank": true
    }
  }'

# ヘルスチェック
curl http://localhost:8000/api/v1/health
```

---

## 🔄 レート制限

| エンドポイント | 制限 | 単位 |
|---------------|------|------|
| /search | 100 | リクエスト/分 |
| /agent/* | 50 | リクエスト/分 |
| /multi-agent/* | 20 | リクエスト/分 |
| /metrics | 1000 | リクエスト/分 |

---

## 📚 参考リンク

- [OpenAPI仕様書](/docs/openapi.yaml)
- [Postmanコレクション](/docs/postman_collection.json)
- [APIプレイグラウンド](http://localhost:8000/docs)

---

*最終更新: 2025年1月21日*