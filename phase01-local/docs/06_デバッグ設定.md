# デバッグ設定ガイド

## 1. ログ出力を強化するlaunch.json設定

```json
{
    "name": "Python: Debug with Logging",
    "type": "debugpy",
    "request": "launch",
    "program": "${workspaceFolder}/phase01-local/src/data_loader_notion.py",
    "console": "integratedTerminal",
    "cwd": "${workspaceFolder}/phase01-local",
    "env": {
        "PYTHONPATH": "${workspaceFolder}/phase01-local",
        "PYTHONUNBUFFERED": "1"  // バッファリングを無効化して即座に出力
    },
    "justMyCode": false,  // ライブラリ内部もステップ実行可能
    "logToFile": true,  // ファイルにログ出力
    "redirectOutput": true,  // 出力をデバッグコンソールにリダイレクト
    "python": "${workspaceFolder}/phase01-local/.venv/bin/python"
}
```

## 2. Pythonコードにデバッグ用ログを追加

```python
import logging
import sys
from datetime import datetime

# ログ設定（ファイルとコンソール両方に出力）
def setup_debug_logging():
    # ログディレクトリ作成
    log_dir = "./logs"
    os.makedirs(log_dir, exist_ok=True)
    
    # ログファイル名（タイムスタンプ付き）
    log_file = f"{log_dir}/debug_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log"
    
    # ログフォーマット設定
    log_format = '%(asctime)s - %(name)s - %(levelname)s - [%(filename)s:%(lineno)d] - %(message)s'
    
    # ルートロガーの設定
    logging.basicConfig(
        level=logging.DEBUG,
        format=log_format,
        handlers=[
            logging.FileHandler(log_file, encoding='utf-8'),
            logging.StreamHandler(sys.stdout)  # コンソールにも出力
        ]
    )
    
    logger = logging.getLogger(__name__)
    logger.info(f"ログファイル: {log_file}")
    return logger

# 使用例
logger = setup_debug_logging()
logger.debug("デバッグ情報")
logger.info("通常情報")
logger.warning("警告")
logger.error("エラー")
```

## 3. ブレークポイントでの変数確認

```python
# デバッグ時に便利な変数確認用コード
def debug_checkpoint(locals_dict, message="Debug Checkpoint"):
    """ブレークポイントで変数を確認しやすくする"""
    print(f"\n{'='*60}")
    print(f"🔍 {message}")
    print(f"{'='*60}")
    
    for key, value in locals_dict.items():
        if not key.startswith('__'):
            print(f"{key}: {type(value).__name__} = {repr(value)[:100]}")
    
    print(f"{'='*60}\n")

# 使用例
def some_function():
    var1 = "test"
    var2 = [1, 2, 3]
    
    # この行にブレークポイントを設定
    debug_checkpoint(locals(), "関数内の変数確認")
```

## 4. 条件付きブレークポイント

VSCode/Cursorで条件付きブレークポイントを設定：
1. ブレークポイントを右クリック
2. 「条件付きブレークポイントの編集」を選択
3. 条件を入力（例: `item_id == "specific_id"`）

## 5. デバッグコンソールでの対話的デバッグ

デバッグ中に一時停止した状態で、デバッグコンソールに直接Pythonコードを入力可能：

```python
# デバッグコンソールで実行できる例
>>> print(metadata)
>>> len(visited_page_ids)
>>> [k for k in locals().keys()]
```

## 6. 環境変数でデバッグモード切り替え

```python
import os

# .envファイルに追加
# DEBUG_MODE=true

DEBUG_MODE = os.getenv("DEBUG_MODE", "false").lower() == "true"

if DEBUG_MODE:
    import pdb
    pdb.set_trace()  # プログラムを一時停止してデバッガを起動
```

## 7. VS Code拡張機能の活用

推奨拡張機能：
- **Python** (ms-python.python): 基本的なPythonサポート
- **Pylance** (ms-python.vscode-pylance): 高度なIntelliSense
- **Python Debugger** (ms-python.debugpy): デバッグ機能強化

## 8. ログファイルの自動監視

```bash
# ターミナルでログファイルをリアルタイム監視
tail -f ./logs/debug_*.log

# または、特定のキーワードを含む行のみ表示
tail -f ./logs/debug_*.log | grep ERROR
```

## 9. デバッグ用ヘルパー関数

```python
def inspect_object(obj, name="Object"):
    """オブジェクトの詳細情報を表示"""
    print(f"\n🔍 Inspecting: {name}")
    print(f"Type: {type(obj)}")
    print(f"ID: {id(obj)}")
    
    if hasattr(obj, '__dict__'):
        print("Attributes:")
        for attr, value in obj.__dict__.items():
            print(f"  - {attr}: {repr(value)[:50]}")
    
    if hasattr(obj, '__len__'):
        print(f"Length: {len(obj)}")
    
    print(f"Methods: {[m for m in dir(obj) if not m.startswith('_')][:10]}")
```

## 10. トラブルシューティング

### よくある問題と解決策

1. **ブレークポイントが機能しない**
   - `"justMyCode": true`を`false`に変更
   - Pythonインタープリタが正しく設定されているか確認

2. **出力が表示されない**
   - `"redirectOutput": true`を追加
   - `PYTHONUNBUFFERED=1`を環境変数に追加

3. **デバッグが遅い**
   - 不要なブレークポイントを削除
   - `"justMyCode": true`に戻す

4. **ログファイルが大きくなりすぎる**
   - ログレベルを`INFO`や`WARNING`に変更
   - ログローテーションを実装