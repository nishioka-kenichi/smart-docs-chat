# システムアーキテクチャ

## 🏗️ 全体構成図

```mermaid
graph TB
    subgraph "ユーザーインターフェース"
        CLI[CLIチャット<br/>cli_chat.py]
    end
    
    subgraph "RAGコア"
        RAG[RAGチェーン<br/>rag_chain.py]
        Memory[会話履歴管理<br/>ConversationBufferMemory]
    end
    
    subgraph "データ収集層"
        NotionLoader[Notionローダー<br/>data_loader_notion.py]
        GoogleLoader[Google Driveローダー<br/>data_loader_google.py]
    end
    
    subgraph "インデックス層"
        Indexer[インデクサー<br/>indexer.py]
        ChromaDB[(ChromaDB<br/>ベクトルストア)]
    end
    
    subgraph "外部API"
        NotionAPI[Notion API]
        GoogleAPI[Google Drive API]
        OpenAI[OpenAI API<br/>GPT-4/Embedding]
    end
    
    subgraph "設定管理"
        Config[設定管理<br/>config/__init__.py]
        Settings[settings.yaml]
        Env[.env]
    end
    
    CLI --> RAG
    RAG --> Memory
    RAG --> ChromaDB
    RAG --> OpenAI
    
    NotionLoader --> NotionAPI
    GoogleLoader --> GoogleAPI
    
    NotionLoader --> Indexer
    GoogleLoader --> Indexer
    Indexer --> ChromaDB
    Indexer --> OpenAI
    
    Config --> Settings
    Config --> Env
    
    RAG --> Config
    Indexer --> Config
    NotionLoader --> Config
    GoogleLoader --> Config
```

## 📊 データフロー

### 1. データ収集フェーズ

```mermaid
sequenceDiagram
    participant User
    participant Loader
    participant API
    participant FileSystem
    
    User->>Loader: データ収集開始
    Loader->>API: 認証
    API-->>Loader: トークン確認
    
    loop ページ/ファイル取得
        Loader->>API: コンテンツ要求
        API-->>Loader: データ返却
        Loader->>FileSystem: Markdown保存
    end
    
    Loader->>FileSystem: メタデータ保存
    Loader-->>User: 完了通知
```

### 2. インデックス構築フェーズ

```mermaid
sequenceDiagram
    participant User
    participant Indexer
    participant FileSystem
    participant OpenAI
    participant ChromaDB
    
    User->>Indexer: インデックス構築開始
    Indexer->>FileSystem: ドキュメント読み込み
    
    loop 各ドキュメント
        Indexer->>Indexer: チャンク分割
        Indexer->>OpenAI: 埋め込みベクトル生成
        OpenAI-->>Indexer: ベクトル返却
        Indexer->>ChromaDB: ベクトル保存
    end
    
    Indexer-->>User: 完了通知
```

### 3. 質問応答フェーズ

```mermaid
sequenceDiagram
    participant User
    participant CLI
    participant RAG
    participant ChromaDB
    participant OpenAI
    
    User->>CLI: 質問入力
    CLI->>RAG: 質問処理要求
    
    RAG->>ChromaDB: 類似文書検索
    ChromaDB-->>RAG: 関連文書返却
    
    RAG->>RAG: プロンプト構築
    RAG->>OpenAI: 回答生成要求
    OpenAI-->>RAG: 回答テキスト
    
    RAG->>RAG: 会話履歴更新
    RAG-->>CLI: 回答+ソース
    CLI-->>User: フォーマット表示
```

## 🗂️ ディレクトリ構造詳細

```
phase01-local/
│
├── 📁 config/                    # 設定管理
│   ├── __init__.py              # Configクラス（設定統合）
│   └── settings.yaml            # システムパラメータ
│
├── 📁 credentials/              # 認証情報（gitignore）
│   └── google_service_account.json
│
├── 📁 data/
│   ├── 📁 chromadb/            # ベクトルDB永続化
│   │   └── [Collection Files]
│   ├── 📁 documents/           # 収集した文書
│   │   ├── 📁 notion/         # Notionマークダウン
│   │   │   ├── *.md
│   │   │   └── metadata.json
│   │   └── 📁 google/         # Google Driveテキスト
│   │       ├── *.txt
│   │       └── metadata.json
│   └── 📁 chat_logs/          # 会話履歴
│       └── chat_history_*.json
│
├── 📁 src/                     # ソースコード
│   ├── cli_chat.py            # UIレイヤー
│   ├── rag_chain.py           # ビジネスロジック
│   ├── indexer.py             # インデックス構築
│   ├── data_loader_notion.py  # Notionデータ取得
│   ├── data_loader_google.py  # Google Driveデータ取得
│   └── debug_helper.py        # デバッグユーティリティ
│
└── 📄 main.py                  # エントリーポイント
```

## 🔧 コンポーネント詳細

### 1. CLI層（cli_chat.py）
- **責務**: ユーザーインタラクション
- **機能**:
  - コマンド解析
  - 表示フォーマット
  - セッション管理
  - エラーハンドリング

### 2. RAG層（rag_chain.py）
- **責務**: 質問応答のコア処理
- **機能**:
  - ベクトル検索
  - プロンプト構築
  - LLM呼び出し
  - 会話履歴管理

### 3. データローダー層
- **責務**: 外部データの取得と変換
- **機能**:
  - API認証
  - ページネーション処理
  - テキスト抽出
  - メタデータ管理

### 4. インデクサー層（indexer.py）
- **責務**: 検索用インデックス構築
- **機能**:
  - テキスト分割
  - ベクトル化
  - ChromaDB永続化
  - バッチ処理

## 🔑 キー技術

### ベクトル埋め込み
```python
# モデル: text-embedding-3-small
# 次元数: 1536
# チャンクサイズ: 500文字
# オーバーラップ: 100文字
```

### 検索パラメータ
```python
# 検索数(k): 10
# スコア閾値: 0.2
# 距離メトリック: コサイン類似度
```

### LLMパラメータ
```python
# モデル: gpt-4o-mini
# Temperature: 0.7
# Max Tokens: 1000
```

## 🔄 処理フローの最適化

### バッチ処理
- ChromaDB追加: 100件ずつ
- 埋め込み生成: 並列処理なし（レート制限対策）

### キャッシュ戦略
- ドキュメント: ファイルシステムキャッシュ
- ベクトルDB: 永続化により再計算不要
- 会話履歴: メモリ内保持

### エラーハンドリング
```python
try:
    # API呼び出し
except RateLimitError:
    # リトライロジック
except AuthenticationError:
    # 認証エラー処理
except Exception as e:
    # 汎用エラー処理
```

## 📈 スケーラビリティ考慮

### 現在の制限
- シングルユーザー
- ローカル実行のみ
- 同期処理

### Phase 2での拡張予定
- マルチユーザー対応
- 非同期処理
- キューイングシステム
- 分散ベクトルDB

### Phase 3での拡張予定
- マイクロサービス化
- Kubernetes対応
- 自動スケーリング
- CDN統合

## 🔒 セキュリティ設計

### 認証情報管理
- 環境変数分離
- .gitignore設定
- ローカル保存のみ

### データ保護
- ローカル処理
- 外部送信最小化
- HTTPSのみ使用

### アクセス制御
- 現状: なし（ローカル実行）
- Phase 2: ユーザー認証
- Phase 3: RBAC実装予定

---

最終更新: 2025年1月20日