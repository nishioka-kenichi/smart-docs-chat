# Phase 2: Advanced RAG ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“å›³

```mermaid
graph TB
    subgraph "å…¥åŠ›å±¤"
        User[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
        Query[è³ªå•]
    end
    
    subgraph "Advanced RAGå±¤"
        subgraph "æ¤œç´¢æ‹¡å¼µ"
            HyDE[HyDE<br/>ä»®æƒ³å›ç­”ç”Ÿæˆ]
            Fusion[RAG-Fusion<br/>è¤‡æ•°ã‚¯ã‚¨ãƒªç”Ÿæˆ]
        end
        
        subgraph "æ¤œç´¢å±¤"
            VectorDB[(ChromaDB<br/>Phase 1å‚ç…§)]
            Search[é¡ä¼¼æ¤œç´¢]
        end
        
        subgraph "å¾Œå‡¦ç†å±¤"
            Merger[çµæœçµ±åˆ]
            Reranker[Reranker<br/>å†é †ä½ä»˜ã‘]
        end
    end
    
    subgraph "ç”Ÿæˆå±¤"
        Context[ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰]
        LLM[GPT-4o-mini]
        Answer[å›ç­”ç”Ÿæˆ]
    end
    
    User --> Query
    Query --> HyDE
    Query --> Fusion
    
    HyDE --> Search
    Fusion --> Search
    Search --> VectorDB
    VectorDB --> Merger
    
    Merger --> Reranker
    Reranker --> Context
    Context --> LLM
    LLM --> Answer
    Answer --> User
    
    style User fill:#FFE4B5
    style Answer fill:#90EE90
    style VectorDB fill:#87CEEB
```

---

## ğŸ“ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 1. HyDEã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```mermaid
classDiagram
    class HyDE {
        -llm: ChatOpenAI
        -embeddings: OpenAIEmbeddings
        -vectorstore: Chroma
        -hyde_prompt: PromptTemplate
        +generate_hypothetical_documents(query, num)
        +search_with_hyde(query, k)
    }
```

**è²¬å‹™**:
- è³ªå•ã‹ã‚‰ä»®æƒ³å›ç­”ã‚’ç”Ÿæˆ
- ä»®æƒ³å›ç­”ã«ã‚ˆã‚‹æ¤œç´¢å®Ÿè¡Œ
- çµæœã®é‡è¤‡é™¤å»

### 2. RAG-Fusionã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```mermaid
classDiagram
    class RAGFusion {
        -llm: ChatOpenAI
        -vectorstore: Chroma
        -query_prompt: PromptTemplate
        +generate_queries(query, num)
        +reciprocal_rank_fusion(results, k)
        +search_with_fusion(query, k)
    }
```

**è²¬å‹™**:
- è¤‡æ•°ã®æ¤œç´¢ã‚¯ã‚¨ãƒªç”Ÿæˆ
- ä¸¦åˆ—æ¤œç´¢ã®å®Ÿè¡Œ
- RRFã«ã‚ˆã‚‹çµæœçµ±åˆ

### 3. Rerankerã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```mermaid
classDiagram
    class BaseReranker {
        <<abstract>>
        +rerank(query, docs, k)
    }
    
    class CohereReranker {
        -client: cohere.Client
        +rerank(query, docs, k)
    }
    
    class CrossEncoderReranker {
        -model: CrossEncoder
        +rerank(query, docs, k)
    }
    
    class HybridReranker {
        -rerankers: List[BaseReranker]
        +rerank(query, docs, k)
    }
    
    BaseReranker <|-- CohereReranker
    BaseReranker <|-- CrossEncoderReranker
    BaseReranker <|-- HybridReranker
```

**è²¬å‹™**:
- æ¤œç´¢çµæœã®å†è©•ä¾¡
- ã‚¹ã‚³ã‚¢ãƒ™ãƒ¼ã‚¹ã®å†é †ä½ä»˜ã‘
- è¤‡æ•°æ‰‹æ³•ã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰å®Ÿè¡Œ

---

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 1. æ¤œç´¢ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant U as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant C as Controller
    participant H as HyDE
    participant F as RAG-Fusion
    participant V as VectorDB
    participant R as Reranker
    
    U->>C: è³ªå•å…¥åŠ›
    
    par ä¸¦åˆ—å‡¦ç†
        C->>H: HyDEæ¤œç´¢ä¾é ¼
        H->>H: ä»®æƒ³å›ç­”ç”Ÿæˆ
        H->>V: ä»®æƒ³å›ç­”ã§æ¤œç´¢
        V-->>H: æ¤œç´¢çµæœA
    and
        C->>F: Fusionæ¤œç´¢ä¾é ¼
        F->>F: è¤‡æ•°ã‚¯ã‚¨ãƒªç”Ÿæˆ
        F->>V: ä¸¦åˆ—æ¤œç´¢
        V-->>F: æ¤œç´¢çµæœB
    end
    
    H-->>C: çµæœAè¿”å´
    F-->>C: çµæœBè¿”å´
    
    C->>C: çµæœçµ±åˆ
    C->>R: å†é †ä½ä»˜ã‘ä¾é ¼
    R-->>C: æœ€çµ‚çµæœ
    C-->>U: ä¸Šä½Kä»¶è¿”å´
```

### 2. å›ç­”ç”Ÿæˆãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant C as Controller
    participant D as Documents
    participant P as Prompt Builder
    participant L as LLM
    participant U as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    
    C->>D: ä¸Šä½æ–‡æ›¸å–å¾—
    D->>P: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰
    P->>P: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
    P->>L: ç”Ÿæˆä¾é ¼
    L->>L: å›ç­”ç”Ÿæˆ
    L-->>C: ç”Ÿæˆçµæœ
    C-->>U: æœ€çµ‚å›ç­”
```

---

## ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### SearchResult
```python
@dataclass
class SearchResult:
    document: Document
    score: float
    method: str  # "hyde", "fusion", "base"
    metadata: Dict[str, Any]
```

### AdvancedRAGResponse
```python
@dataclass
class AdvancedRAGResponse:
    query: str
    answer: str
    source_documents: List[Document]
    scores: List[float]
    retrieval_time: float
    generation_time: float
    total_time: float
    config_used: Dict[str, bool]
```

---

## âš™ï¸ è¨­å®šç®¡ç†

### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«æ§‹é€ 

```yaml
# config/settings.yaml

# ChromaDBè¨­å®šï¼ˆPhase 1ã‚’å‚ç…§ï¼‰
chromadb:
  persist_directory: "../phase01-local/data/chromadb"
  collection_name: "phase01_documents"

# HyDEè¨­å®š
hyde:
  enabled: true
  num_hypothetical: 3
  temperature: 0.7
  max_length: 500

# RAG-Fusionè¨­å®š
fusion:
  enabled: true
  num_queries: 5
  rrf_k: 60

# Rerankerè¨­å®š
reranker:
  enabled: true
  type: "hybrid"  # "cohere", "cross_encoder", "hybrid"
  top_k: 10
  
# LLMè¨­å®š
llm:
  model: "gpt-4o-mini"
  temperature: 0.7
  max_tokens: 1000

# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨­å®š
performance:
  cache_enabled: true
  cache_ttl: 3600
  batch_size: 10
  max_workers: 4
```

---

## ğŸ” ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥

```mermaid
graph TD
    A[å‡¦ç†é–‹å§‹] --> B{HyDEæˆåŠŸ?}
    B -->|Yes| C[HyDEçµæœä½¿ç”¨]
    B -->|No| D[é€šå¸¸æ¤œç´¢ã¸]
    
    C --> E{FusionæˆåŠŸ?}
    D --> E
    
    E -->|Yes| F[Fusionçµæœè¿½åŠ ]
    E -->|No| G[å˜ä¸€æ¤œç´¢çµæœ]
    
    F --> H{RerankeræˆåŠŸ?}
    G --> H
    
    H -->|Yes| I[å†é †ä½ä»˜ã‘çµæœ]
    H -->|No| J[å…ƒã®é †ä½ç¶­æŒ]
    
    I --> K[æœ€çµ‚çµæœ]
    J --> K
```

### ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ã¨å¯¾å‡¦

| ã‚¨ãƒ©ãƒ¼ç¨®åˆ¥ | åŸå›  | å¯¾å‡¦æ³• |
|-----------|------|--------|
| API Timeout | ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ | ãƒªãƒˆãƒ©ã‚¤ï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰ |
| Rate Limit | APIåˆ¶é™è¶…é | å¾…æ©Ÿå¾Œãƒªãƒˆãƒ©ã‚¤ or ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| Memory Error | ãƒ¢ãƒ‡ãƒ«ã‚µã‚¤ã‚ºå¤§ | ãƒãƒƒãƒã‚µã‚¤ã‚ºå‰Šæ¸› |
| Invalid Response | LLMå‡ºåŠ›ã‚¨ãƒ©ãƒ¼ | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´ or å†å®Ÿè¡Œ |

---

## ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### ç›£è¦–ãƒ¡ãƒˆãƒªã‚¯ã‚¹

1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
   - å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å‡¦ç†æ™‚é–“
   - ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·
   - ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆï¼ˆreq/secï¼‰

2. **å“è³ª**
   - æ¤œç´¢ç²¾åº¦ï¼ˆPrecision/Recallï¼‰
   - å›ç­”ã®é–¢é€£æ€§ã‚¹ã‚³ã‚¢
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯

3. **ãƒªã‚½ãƒ¼ã‚¹**
   - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡
   - APIå‘¼ã³å‡ºã—å›æ•°
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡

### ãƒ­ã‚°è¨­è¨ˆ

```python
# ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«
DEBUG: è©³ç´°ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼
INFO: ä¸»è¦ãªå‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—
WARNING: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç™ºç”Ÿ
ERROR: ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ
```

---

## ğŸš€ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- æ¤œç´¢å‡¦ç†ã®ä¸¦åˆ—åŒ–
- è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã§ã®è² è·åˆ†æ•£

### å‚ç›´ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
- GPUã«ã‚ˆã‚‹ãƒ¢ãƒ‡ãƒ«æ¨è«–é«˜é€ŸåŒ–
- ãƒ¡ãƒ¢ãƒªå¢—è¨­ã«ã‚ˆã‚‹å¤§è¦æ¨¡ãƒãƒƒãƒå‡¦ç†

### ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥
- ã‚¯ã‚¨ãƒªçµæœã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆTTL: 1æ™‚é–“ï¼‰
- åŸ‹ã‚è¾¼ã¿ãƒ™ã‚¯ãƒˆãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- LLMå¿œç­”ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆåŒä¸€è³ªå•ï¼‰

---

*æœ€çµ‚æ›´æ–°: 2025å¹´1æœˆ21æ—¥*